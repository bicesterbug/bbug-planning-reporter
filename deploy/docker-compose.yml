# Production Docker Compose — pulls pre-built images from GHCR
#
# Usage:
#   docker compose up -d          # Start all services
#   docker compose --profile seed run --rm fetch-policies  # Download seed PDFs
#   docker compose --profile seed run --rm policy-init     # Seed ChromaDB
#   docker compose down           # Stop all services
#
# See deploy.sh for an all-in-one deployment script.

services:
  # ==========================================================================
  # API Gateway - FastAPI REST API
  # ==========================================================================
  api:
    image: ghcr.io/bicesterbug/bbug-planning-reporter/api:${IMAGE_TAG:-latest}
    environment:
      - API_KEYS=${API_KEYS:?API_KEYS is required — set in .env}
      - REDIS_URL=redis://redis:6379/0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ADVOCACY_GROUP_NAME=${ADVOCACY_GROUP_NAME:-Bicester Bike Users' Group}
      - ADVOCACY_GROUP_STYLISED=${ADVOCACY_GROUP_STYLISED:-Bicester BUG}
      - ADVOCACY_GROUP_SHORT=${ADVOCACY_GROUP_SHORT:-BBUG}
    ports:
      - "${API_PORT:-8080}:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bbug-api.rule=Host(`bbug-planning.mmsio.com`)"
      - "traefik.http.routers.bbug-api.entrypoints=websecure"
      - "traefik.http.routers.bbug-api.tls.certresolver=myresolver"
      - "traefik.http.services.bbug-api.loadbalancer.server.port=8080"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent-net
      - traefik_default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # ==========================================================================
  # Worker - arq job processor
  # ==========================================================================
  worker:
    image: ghcr.io/bicesterbug/bbug-planning-reporter/worker:${IMAGE_TAG:-latest}
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required — set in .env}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-5-20250929}
      - DOCUMENT_FILTER_MODEL=${DOCUMENT_FILTER_MODEL:-claude-haiku-4-5-20251001}
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_PERSIST_DIR=/data/chroma
      - RAW_DOCS_DIR=/data/raw
      - OUTPUT_DIR=/data/output
      - POLICY_DOCS_DIR=/data/policy
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - SCRAPER_RATE_LIMIT=${SCRAPER_RATE_LIMIT:-1.0}
      - SCRAPER_USER_AGENT=${SCRAPER_USER_AGENT:-CherwellCycleReview/1.0}
      - WEBHOOK_URL=${WEBHOOK_URL:-}
      - WEBHOOK_TIMEOUT=${WEBHOOK_TIMEOUT:-10}
      - WEBHOOK_MAX_RETRIES=${WEBHOOK_MAX_RETRIES:-5}
      - CHERWELL_SCRAPER_URL=http://cherwell-scraper-mcp:3001
      - DOCUMENT_STORE_URL=http://document-store-mcp:3002
      - POLICY_KB_URL=http://policy-kb-mcp:3003
      - CYCLE_ROUTE_URL=http://cycle-route-mcp:3004
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ADVOCACY_GROUP_NAME=${ADVOCACY_GROUP_NAME:-Bicester Bike Users' Group}
      - ADVOCACY_GROUP_STYLISED=${ADVOCACY_GROUP_STYLISED:-Bicester BUG}
      - ADVOCACY_GROUP_SHORT=${ADVOCACY_GROUP_SHORT:-BBUG}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL:-}
      - S3_BUCKET=${S3_BUCKET:-}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_KEY_PREFIX=${S3_KEY_PREFIX:-planning}
      - S3_REGION=${S3_REGION:-}
    volumes:
      - ${DATA_DIR:-./data}/chroma:/data/chroma
      - ${DATA_DIR:-./data}/raw:/data/raw
      - ${DATA_DIR:-./data}/output:/data/output
      - ${DATA_DIR:-./data}/policy:/data/policy
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent-net
    restart: unless-stopped
    deploy:
      replicas: ${WORKER_REPLICAS:-1}
      resources:
        limits:
          memory: 4G

  # ==========================================================================
  # Redis - Job queue, state store, pub/sub
  # ==========================================================================
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - ${DATA_DIR:-./data}/redis:/data
    networks:
      - agent-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

  # ==========================================================================
  # Cherwell Scraper MCP Server
  # ==========================================================================
  cherwell-scraper-mcp:
    image: ghcr.io/bicesterbug/bbug-planning-reporter/cherwell-scraper-mcp:${IMAGE_TAG:-latest}
    environment:
      - CHERWELL_PORTAL_URL=${CHERWELL_PORTAL_URL:-https://planningregister.cherwell.gov.uk}
      - CHERWELL_SCRAPER_PORT=3001
      - SCRAPER_RATE_LIMIT=${SCRAPER_RATE_LIMIT:-1.0}
      - SCRAPER_USER_AGENT=${SCRAPER_USER_AGENT:-CherwellCycleReview/1.0}
      - MCP_API_KEY=${MCP_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ${DATA_DIR:-./data}/raw:/data/raw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp-scraper.rule=Host(`bbug-planning.mmsio.com`) && PathPrefix(`/mcp/cherwell-scraper/`)"
      - "traefik.http.routers.mcp-scraper.entrypoints=websecure"
      - "traefik.http.routers.mcp-scraper.tls.certresolver=myresolver"
      - "traefik.http.middlewares.mcp-scraper-strip.stripprefix.prefixes=/mcp/cherwell-scraper"
      - "traefik.http.routers.mcp-scraper.middlewares=mcp-scraper-strip"
      - "traefik.http.services.mcp-scraper.loadbalancer.server.port=3001"
    networks:
      - agent-net
      - traefik_default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  # ==========================================================================
  # Document Store MCP Server
  # ==========================================================================
  document-store-mcp:
    image: ghcr.io/bicesterbug/bbug-planning-reporter/document-store-mcp:${IMAGE_TAG:-latest}
    environment:
      - CHROMA_PERSIST_DIR=/data/chroma
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - ENABLE_OCR=${ENABLE_OCR:-true}
      - MCP_API_KEY=${MCP_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ${DATA_DIR:-./data}/chroma:/data/chroma
      - ${DATA_DIR:-./data}/raw:/data/raw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp-docstore.rule=Host(`bbug-planning.mmsio.com`) && PathPrefix(`/mcp/document-store/`)"
      - "traefik.http.routers.mcp-docstore.entrypoints=websecure"
      - "traefik.http.routers.mcp-docstore.tls.certresolver=myresolver"
      - "traefik.http.middlewares.mcp-docstore-strip.stripprefix.prefixes=/mcp/document-store"
      - "traefik.http.routers.mcp-docstore.middlewares=mcp-docstore-strip"
      - "traefik.http.services.mcp-docstore.loadbalancer.server.port=3002"
    networks:
      - agent-net
      - traefik_default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  # ==========================================================================
  # Policy KB MCP Server
  # ==========================================================================
  policy-kb-mcp:
    image: ghcr.io/bicesterbug/bbug-planning-reporter/policy-kb-mcp:${IMAGE_TAG:-latest}
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_PERSIST_DIR=/data/chroma
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - MCP_API_KEY=${MCP_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ${DATA_DIR:-./data}/chroma:/data/chroma
      - ${DATA_DIR:-./data}/policy:/data/policy
    depends_on:
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp-policykb.rule=Host(`bbug-planning.mmsio.com`) && PathPrefix(`/mcp/policy-kb/`)"
      - "traefik.http.routers.mcp-policykb.entrypoints=websecure"
      - "traefik.http.routers.mcp-policykb.tls.certresolver=myresolver"
      - "traefik.http.middlewares.mcp-policykb-strip.stripprefix.prefixes=/mcp/policy-kb"
      - "traefik.http.routers.mcp-policykb.middlewares=mcp-policykb-strip"
      - "traefik.http.services.mcp-policykb.loadbalancer.server.port=3003"
    networks:
      - agent-net
      - traefik_default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G

  # ==========================================================================
  # Cycle Route MCP Server
  # ==========================================================================
  cycle-route-mcp:
    image: ghcr.io/bicesterbug/bbug-planning-reporter/cycle-route-mcp:${IMAGE_TAG:-latest}
    environment:
      - CYCLE_ROUTE_PORT=3004
      - MCP_API_KEY=${MCP_API_KEY:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp-cycleroute.rule=Host(`bbug-planning.mmsio.com`) && PathPrefix(`/mcp/cycle-route/`)"
      - "traefik.http.routers.mcp-cycleroute.entrypoints=websecure"
      - "traefik.http.routers.mcp-cycleroute.tls.certresolver=myresolver"
      - "traefik.http.middlewares.mcp-cycleroute-strip.stripprefix.prefixes=/mcp/cycle-route"
      - "traefik.http.routers.mcp-cycleroute.middlewares=mcp-cycleroute-strip"
      - "traefik.http.services.mcp-cycleroute.loadbalancer.server.port=3004"
    networks:
      - agent-net
      - traefik_default
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # ==========================================================================
  # Seed: Fetch policy PDFs into the policy-data volume
  # ==========================================================================
  fetch-policies:
    image: curlimages/curl:latest
    profiles: [seed]
    user: "0:0"
    volumes:
      - ${DATA_DIR:-./data}/policy:/data/policy
      - ./seed_config.json:/seed_config.json:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        set -e
        mkdir -p /data/policy/seed
        cp /seed_config.json /data/policy/seed_config.json

        download() {
          url="$$1"; filename="$$2"; description="$$3"
          target="/data/policy/seed/$$filename"
          if [ -f "$$target" ]; then
            echo "[SKIP] $$description (already exists)"
            return 0
          fi
          echo "[DOWNLOAD] $$description"
          if curl -fSL --progress-bar -o "$$target" "$$url"; then
            echo "  Done"
          else
            echo "  FAILED"
            rm -f "$$target"
            return 1
          fi
        }

        echo "=== Fetching seed policy documents ==="
        download "https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/951074/cycle-infrastructure-design-ltn-1-20.pdf" \
          "ltn_1_20.pdf" "LTN 1/20 - Cycle Infrastructure Design"
        download "https://assets.publishing.service.gov.uk/media/67aafe8f3b41f783cca46251/NPPF_December_2024.pdf" \
          "nppf_2024_12.pdf" "NPPF December 2024"
        download "https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/1182995/NPPF_Sept_23.pdf" \
          "nppf_2023_09.pdf" "NPPF September 2023"
        download "https://assets.publishing.service.gov.uk/media/5a7e0035ed915d74e6223743/pdfmanforstreets.pdf" \
          "manual_for_streets.pdf" "Manual for Streets"
        download "https://www.cherwell.gov.uk/download/downloads/id/8144/final-adopted-local-plan-2011-2031-incorporating-re-adopted-policy-bicester-13.pdf" \
          "cherwell_local_plan_2015.pdf" "Cherwell Local Plan 2011-2031"
        download "https://www.southandvale.gov.uk/app/uploads/2024/12/LNP10-Oxfordshire-Local-Transport-and-Connectivity-Plan-LTCP.pdf" \
          "occ_ltcp_2022.pdf" "Oxfordshire LTCP"
        download "https://www.oxfordshire.gov.uk/sites/default/files/file/roads-and-transport-connecting-oxfordshire/Bicester_LCWIP_2020.pdf" \
          "bicester_lcwip.pdf" "Bicester LCWIP"

        echo "=== Download complete ==="
        ls -lh /data/policy/seed/
    networks:
      - agent-net

  # ==========================================================================
  # Seed: Ingest policies into ChromaDB
  # ==========================================================================
  policy-init:
    image: ghcr.io/bicesterbug/bbug-planning-reporter/policy-init:${IMAGE_TAG:-latest}
    profiles: [seed]
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_PERSIST_DIR=/data/chroma
      - SEED_CONFIG_PATH=/data/policy/seed_config.json
      - SEED_DIR=/data/policy/seed
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ${DATA_DIR:-./data}/chroma:/data/chroma
      - ${DATA_DIR:-./data}/policy:/data/policy
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent-net
    restart: "no"

# ==========================================================================
# Networks
# ==========================================================================
networks:
  agent-net:
    driver: bridge
  traefik_default:
    external: true
