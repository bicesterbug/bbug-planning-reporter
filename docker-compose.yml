# Cherwell Cycle Agent - Docker Compose Stack
# Implements [foundation-api:NFR-005] - Containerisation
#
# Usage:
#   docker compose build    # Build all images
#   docker compose up -d    # Start all services
#   docker compose logs -f  # Follow logs
#   docker compose down     # Stop all services

services:
  # ==========================================================================
  # API Gateway - FastAPI REST API
  # ==========================================================================
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    environment:
      - API_KEYS=${API_KEYS:-sk-cycle-dev-key-1}
      - REDIS_URL=redis://redis:6379/0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ADVOCACY_GROUP_NAME=${ADVOCACY_GROUP_NAME:-Bicester Bike Users' Group}
      - ADVOCACY_GROUP_STYLISED=${ADVOCACY_GROUP_STYLISED:-Bicester BUG}
      - ADVOCACY_GROUP_SHORT=${ADVOCACY_GROUP_SHORT:-BBUG}
    ports:
      - "8080:8080"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent-net
    restart: unless-stopped

  # ==========================================================================
  # Worker - arq job processor
  # ==========================================================================
  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-5-20250929}
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_PERSIST_DIR=/data/chroma
      - RAW_DOCS_DIR=/data/raw
      - OUTPUT_DIR=/data/output
      - POLICY_DOCS_DIR=/data/policy
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - SCRAPER_RATE_LIMIT=${SCRAPER_RATE_LIMIT:-1.0}
      - SCRAPER_USER_AGENT=${SCRAPER_USER_AGENT:-CherwellCycleReview/1.0}
      - WEBHOOK_URL=${WEBHOOK_URL:-}
      - WEBHOOK_TIMEOUT=${WEBHOOK_TIMEOUT:-10}
      - WEBHOOK_MAX_RETRIES=${WEBHOOK_MAX_RETRIES:-5}
      - CHERWELL_SCRAPER_URL=http://cherwell-scraper-mcp:3001
      - DOCUMENT_STORE_URL=http://document-store-mcp:3002
      - POLICY_KB_URL=http://policy-kb-mcp:3003
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ADVOCACY_GROUP_NAME=${ADVOCACY_GROUP_NAME:-Bicester Bike Users' Group}
      - ADVOCACY_GROUP_STYLISED=${ADVOCACY_GROUP_STYLISED:-Bicester BUG}
      - ADVOCACY_GROUP_SHORT=${ADVOCACY_GROUP_SHORT:-BBUG}
      # S3-compatible storage (optional - omit to use local volumes)
      # When set, documents are uploaded to S3 after download and URLs in
      # reviews point to the S3 bucket instead of the Cherwell portal.
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL:-}
      - S3_BUCKET=${S3_BUCKET:-}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_KEY_PREFIX=${S3_KEY_PREFIX:-planning}
      - S3_REGION=${S3_REGION:-}
    volumes:
      - /media/pete/Files/bbug-reports/chroma:/data/chroma
      - /media/pete/Files/bbug-reports/raw:/data/raw
      - /media/pete/Files/bbug-reports/output:/data/output
      - ./data/policy:/data/policy
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent-net
    restart: unless-stopped
    deploy:
      replicas: ${WORKER_REPLICAS:-1}

  # ==========================================================================
  # Redis - Job queue, state store, pub/sub
  # ==========================================================================
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - /media/pete/Files/bbug-reports/redis:/data
    ports:
      - "6379:6379"  # Expose for local debugging; remove in prod
    networks:
      - agent-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ==========================================================================
  # Document Store MCP Server (Phase 2)
  # ==========================================================================
  document-store-mcp:
    build:
      context: .
      dockerfile: docker/Dockerfile.document-store
    environment:
      - CHROMA_PERSIST_DIR=/data/chroma
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - ENABLE_OCR=${ENABLE_OCR:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "3002:3002"
    volumes:
      - /media/pete/Files/bbug-reports/chroma:/data/chroma
      - /media/pete/Files/bbug-reports/raw:/data/raw
    networks:
      - agent-net
    restart: unless-stopped

  # ==========================================================================
  # Cherwell Scraper MCP Server (Phase 1)
  # ==========================================================================
  cherwell-scraper-mcp:
    build:
      context: .
      dockerfile: docker/Dockerfile.scraper
    environment:
      - CHERWELL_PORTAL_URL=${CHERWELL_PORTAL_URL:-https://planningregister.cherwell.gov.uk}
      - CHERWELL_SCRAPER_PORT=3001
      - SCRAPER_RATE_LIMIT=${SCRAPER_RATE_LIMIT:-1.0}
      - SCRAPER_USER_AGENT=${SCRAPER_USER_AGENT:-CherwellCycleReview/1.0}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "3001:3001"
    volumes:
      - /media/pete/Files/bbug-reports/raw:/data/raw
    networks:
      - agent-net
    restart: unless-stopped

  # ==========================================================================
  # Policy KB MCP Server
  # Implements [policy-knowledge-base:FR-005] - Policy search with temporal filtering
  # ==========================================================================
  policy-kb-mcp:
    build:
      context: .
      dockerfile: docker/Dockerfile.policy-kb
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_PERSIST_DIR=/data/chroma
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "3003:3003"
    volumes:
      - /media/pete/Files/bbug-reports/chroma:/data/chroma
      - ./data/policy:/data/policy
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent-net
    restart: unless-stopped

  # ==========================================================================
  # Policy Init Container - Seeds initial policies at first deployment
  # Implements [policy-knowledge-base:FR-013] - Seed initial policies
  # ==========================================================================
  policy-init:
    build:
      context: .
      dockerfile: docker/Dockerfile.policy-init
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CHROMA_PERSIST_DIR=/data/chroma
      - SEED_CONFIG_PATH=/data/policy/seed_config.json
      - SEED_DIR=/data/policy/seed
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - /media/pete/Files/bbug-reports/chroma:/data/chroma
      - ./data/policy:/data/policy
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - agent-net
    # Runs once at startup, then exits
    restart: "no"

# ==========================================================================
# Networks
# ==========================================================================
networks:
  agent-net:
    driver: bridge
